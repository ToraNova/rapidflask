{% extends 'support/gentelella.html' %}

<!--Import line from a pre-defined formhelpers in the include dir-->
{% from "includes/helpers/_formhelpers.html" import render_field %}

{% block head %}
<!-- iCheck -->
<link href="{{url_for('static', filename='vendors/iCheck/skins/flat/green.css')}}" rel="stylesheet">
{% endblock %}

{% block body %}
<div class="page-title">
	<div class="title_left">
		<h3> <small></small></h3>
		<!-- No title on left -->
	</div>

	<div class="title_right">
		<h3> <small></small></h3>
		<!-- No title on right -->
	</div>
</div>

<div class="clearfix"></div>

<div class="row">
	<div class="col-md-12 col-sm-12 col-xs-12">
		<div class="x_panel">
		<div class="x_title">
			<h2>MQTT Broker Service (Eclipse-Mosquitto)<small></small></h2>
			<div class="clearfix"></div>
		</div>
		<div class="x_content">

			<br/>
			<!--Content-->
			<div class="row">
				<div class="col-md-9 col-sm-9 col-xs-9">

					<label for="mosquitto_output" id="oview_label">Broker Output</label>
					<textarea id='mosquitto_output' class='col-md-12' rows="30" cols="160" wrap="soft"
					style="max-height:500px;min-height:500px; resize: none"></textarea>

				</div>
			</div>
			{% include 'includes/helpers/_space1br.html' %}
			<div class="row">
				<div class="col-md-8 col-sm-8 col-xs-8">
					<button class="btn btn-success" onclick="brokerstart();">Start Broker Service</button>
					<button class="btn btn-danger" onclick="brokerstop();">Stop Broker Service</button>
					<button class="btn btn-warning" onclick="cleardisp();">Clear Display</button>
					<button class="btn btn-normal" onclick="refreshdisp();">Refresh Display</button>
				</div>
				<!--
				<div class="col-md-3 col-sm-3 col-xs-3">
					<input  name="button" value="Stop Broker Service" class="btn btn-danger"></input>
				</div>
				<div class="col-md-3 col-sm-3 col-xs-3">
					<input name="button" value="Start Broker Service" class="btn btn-success"></input>
				</div>
				-->
			</div>
			{% include 'includes/helpers/_space1br.html' %}
			<div class="row">
				<pre id="mosquitto_qstat"></pre> 
			</div>

		</div>

		</div>
	</div>
	</div>
</div>

{% endblock %}

{% block script %}
	<script type="text/javascript" src="{{url_for('static', filename='flask_io/socket.io.min.js')}}"></script>
	<script type="text/javascript" charset="utf-8">
	var namespace = '/brokerctl'
	var socket = io.connect('{{socket_io_proto}}://' + document.domain + ':' + location.port + namespace); //persistent
	socket.on('connect', function() {
		console.log("mqtt_brokerlogs connected..."+namespace);
	});

	function brokerstart(){
		document.getElementById('mosquitto_qstat').innerHTML="starting broker.";
		socket.emit('start');
		setTimeout( refreshdisp, 3000);
	}

	function brokerstop(){
		document.getElementById('mosquitto_qstat').innerHTML="stopping broker.";
		socket.emit('stop');
		//setTimeout( refreshdisp, 3000);
	}

	function cleardisp(){
		document.getElementById('mosquitto_output').value = '';
	}

	function refreshdisp(){
		socket.emit('refresh');
	}

	socket.on('brokerlogs_cast', function(msg){
		console.log(msg.logstring)
		document.getElementById('mosquitto_output').value = (document.getElementById('mosquitto_output').value +
		new Date().toLocaleString() + ' :: ' + msg.logstring + '\n');
	});

	socket.on('brokerqstat_cast', function(msg){
		console.log(msg.statstring)
		document.getElementById('mosquitto_qstat').innerHTML = msg.statstring;
	});
	</script>
{% endblock %}
